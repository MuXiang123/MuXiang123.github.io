---
title: æ‰‹å†™ç®€æ˜“Netty_01â€”â€”æ­å»ºé¡¹ç›®
date: 2023-07-03 20:35:16
tags: 
 - Netty
 - Java
 - Tiny_Netty
categories:
 - [Tiny_Netty]
 - [Netty]
---



# åŸºæœ¬æ­¥éª¤ ğŸš€

![image-20230622192508774](img/æ‰‹å†™ç®€æ˜“Netty-01/image-20230622192508774-16883882639981.png)

![image-20230622192533845](img/æ‰‹å†™ç®€æ˜“Netty-01/image-20230622192533845-16883882639992.png)

# æ¡ˆä¾‹ä»‹ç»å’Œè®¾è®¡æ•°æ®ç»“æ„ ğŸ’¡

æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆserverï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼Œä»¥æ”¯æŒç½‘ç»œé€šä¿¡ï¼ŒåŒ…æ‹¬è¯·æ±‚å’Œå“åº”ã€‚åŒæ—¶è®¾è®¡äº†ä¸¤ä¸ªæ¥å£ï¼Œç”¨äºæˆæƒå’Œä¿æŒè¿æ¥çš„è¯·æ±‚å’Œå“åº”ã€‚



![image-20230622193251995](img/æ‰‹å†™ç®€æ˜“Netty-01/image-20230622193251995.png)





æ¶ˆæ¯ä½“ï¼ˆbodyï¼‰ä½¿ç”¨ JSON æ ¼å¼ï¼Œè¡¨ç¤ºæ“ä½œï¼ˆoperationï¼‰çš„è¯·æ±‚å’Œå“åº”ã€‚

æ¶ˆæ¯å¤´ï¼ˆheaderï¼‰ä¸­æœ‰å¤šç§æ“ä½œç±»å‹ï¼ˆOPï¼‰ï¼Œéœ€è¦å®šä¹‰ä¸åŒçš„æ“ä½œä»£ç ï¼ˆOP_Codeï¼‰ã€‚ç‰ˆæœ¬ï¼ˆversionï¼‰ç”¨äºè¡¨ç¤ºç‰ˆæœ¬å·å’Œå¤„ç†å…¼å®¹æ€§ã€‚æµIDï¼ˆstreamIDï¼‰ç”¨ä½œå”¯ä¸€æ ‡è¯†ç¬¦ã€‚

é•¿åº¦å­—æ®µè¡¨ç¤ºæ¶ˆæ¯çš„é•¿åº¦ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå¸§ï¼ˆframeï¼‰ã€‚



![image-20230622193446330](img/æ‰‹å†™ç®€æ˜“Netty-01/image-20230622193446330.png)



æˆ‘ä»¬ä¸æ·±å…¥ä¸šåŠ¡é€»è¾‘ï¼Œåªå…³æ³¨æ€æƒ³å’Œæµç¨‹ã€‚

# å¸¸è§æ˜“é”™ç‚¹ ğŸ”

- `LengthFieldBasedFrameDecoder` ä¸­æœªæ­£ç¡®è®¾ç½® `initialBytesToStrip`ã€‚å¦‚æœæœªè®¾ç½®ï¼Œè§£å†³ç²˜åŒ…å’ŒåŠåŒ…é—®é¢˜æ—¶ï¼Œä»ç„¶ä¼šæºå¸¦é•¿åº¦å­—æ®µã€‚

- `ChannelHandler` çš„é¡ºåºä¸æ­£ç¡®ï¼š

  - ç¼–å†™é¡ºåºåº”æŒ‰ç…§1~5è¿›è¡Œç¼–å†™ï¼Œä½†æ‰§è¡Œé¡ºåºæ˜¯ 1 -> 4 -> 2 -> 3 -> 5ã€‚

  ```java
  1. pipeline.addLast(new OrderFrameDecoder());
  2. pipeline.addLast(new OrderFrameEncoder());
  3. pipeline.addLast(new OrderProtocolEncoder());
  4. pipeline.addLast(new OrderProtocolDecoder());
  5. pipeline.addLast(new OrderServerProcessHandler());
  ```

- `ChannelHandler` å…±äº«ä¸éå…±äº«é—®é¢˜ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ï¼š

  - ä¾‹å¦‚ï¼Œ`pipeline.addLast(new LoggingHandler(LogLevel.INFO));` ä¸­çš„ `LoggingHandler` æ˜¯å¯ä»¥å…±äº«çš„ï¼Œå› æ­¤ä¸éœ€è¦åœ¨æ¯ä¸ª `ChannelHandler` ä¸­åˆ›å»ºã€‚ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä¸åº”è¯¥å…±äº«çš„ `Handler` å´è¢«å…±äº«äº†ï¼Œå°±ä¼šå‡ºç°çº¿ç¨‹é—®é¢˜ã€‚

- åˆ†é… `ByteBuf`ï¼šåº”ä½¿ç”¨ `ByteBufAllocator.DEFAULT` ç­‰åˆ†é…å™¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `ChannelHandlerContext.alloc()`ã€‚åœ¨åˆ†é… `ByteBuf` æ—¶ï¼Œæ— è®ºæ˜¯å †å¤–å†…å­˜è¿˜æ˜¯å †å†…å†…å­˜ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœåˆ‡æ¢äº†å®ç°æ–¹å¼ï¼Œé‚£ä¹ˆä½¿ç”¨äº† `ByteBufAllocator.DEFAULT` çš„åœ°æ–¹ï¼Œå®ç°æ–¹å¼ä¸ä¸€è‡´ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚

- æœªè€ƒè™‘é‡Šæ”¾ `ByteBuf`ï¼š

  - å³ä½¿ä¸æ¥æ”¶æ¶ˆæ¯ï¼Œä»ç„¶åº”è°ƒç”¨ `release` æ–¹æ³•è¿›è¡Œé‡Šæ”¾ã€‚

- é”™è¯¯åœ°è®¤ä¸º `ChannelHandlerContext.write(msg)` å°±ä¼šå°†æ•°æ®å†™å‡ºï¼š

  - `write` æ–¹æ³•åªæ˜¯å°†æ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚
  - è¯¥æ–¹æ³•ä»…åœ¨å½“å‰ `pipeline` çš„ä½ç½®å¯»æ‰¾ä¸‹ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ `handler`ã€‚

- è¯¯ç”¨ `ChannelHandlerContext.channel().writeAndFlush(msg)`ï¼š

  - æ­¤æ¶ˆæ¯å‘é€ä¼šä½¿æ•´ä¸ª `pipeline` é‡æ–°æ‰§è¡Œä¸€éã€‚å¦‚æœåœ¨ä¸­é—´çš„å¤„ç†å™¨æ‰§è¡Œäº†è¯¥æ–¹æ³•ï¼Œå°†ä¼šä»å¤´å¼€å§‹æ‰§è¡Œï¼Œå¯¼è‡´æ­»å¾ªç¯ã€‚

